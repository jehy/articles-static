<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="verify-admitad" content="71b6485389" />
  
  <title>Публикация локального сервера из дома в интернет | Jehy&#39;s notes</title>
  <meta name="author" content="Jehy">
  
  <meta name="description" content="Оригинал поста на хабре
Приветики. Надеюсь, все отошли от новогодних, и можно писать и читать дальше. Как хозяин умного дома, я состою в чатике по Home Assistant, там прекрасное отзывчивое комьюнити,
но периодически задаётся вопрос по тому, как собственно выставить свой веб сервис в интернет. И оказывается, что в двух словах тут не ответишь, а вменяемой инструкции на которую можно дать ссылку - нет. Так что теперь она будет здесь.
Рокет сайнса здесь не встретите, и в целом все эти вещи справедливы и работают уже минимум лет 10, просто не так тривиально понять, какой именно запрос нужно задать в гугл, и что делать.
Мы рассмотрим здесь несколько сценариев - статический белый айпи, динамический белый айпи, и серый. Для серого рассмотрим варианты с готовыми сервисами, с помощью Keenetic и с помощью ssh туннеля. Погнали!
Дисклеймер. Если вы собираетесь хостить обычный веб сайт, визитку, магазин и так далее - автор настоятельно рекомендует вам не страдать фигнёй, а развернуться целиком где-то в облаке. Домашний сервер оправдан для локальных сценариев вроде умного дома или хранилища (которое при этом резервируется в веб), но в долгосрочной перспективе принесёт вам боль и страдания, если вы положите туда что-то, что не должно там лежать и имеет требования по отказоустойчивости.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Публикация локального сервера из дома в интернет"/>
  <meta property="og:site_name" content="Jehy&#39;s notes"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Jehy&#39;s notes" type="application/atom+xml">
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Jehy&#39;s notes</a></h1>
  <h2><a href="/">Insert 1 into dual</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/wishlist">Wishlist</a></li>
    
      <li><a href="/donate">Donate</a></li>
    
      <li><a href="/atom.xml">Subscribe</a></li>
    
      <li><a target="_blank" rel="noopener" href="https://whois.jehy.ru">Contact me</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-2024/01/публикация-локального-сервера-из-дома-в-интернет" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2024-01-09T17:52:54.000Z"><a href="/2024/01/публикация-локального-сервера-из-дома-в-интернет/">2024-01-09</a></time>
      
      
  
    <h1 class="p-name title" itemprop="headline name">Публикация локального сервера из дома в интернет</h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://habr.com/ru/post/785328">Оригинал поста на хабре</a></p>
<p>Приветики. Надеюсь, все отошли от новогодних, и можно писать и читать дальше. Как хозяин умного дома, я состою в чатике по Home Assistant, там прекрасное отзывчивое комьюнити,
но периодически задаётся вопрос по тому, как собственно выставить свой веб сервис в интернет. И оказывается, что в двух словах тут не ответишь, а вменяемой инструкции на которую можно дать ссылку - нет. Так что теперь она будет здесь.</p>
<p>Рокет сайнса здесь не встретите, и в целом все эти вещи справедливы и работают уже минимум лет 10, просто не так тривиально понять, какой именно запрос нужно задать в гугл, и что делать.</p>
<p>Мы рассмотрим здесь несколько сценариев - статический белый айпи, динамический белый айпи, и серый. Для серого рассмотрим варианты с готовыми сервисами, с помощью Keenetic и с помощью ssh туннеля. Погнали!</p>
<p>Дисклеймер. Если вы собираетесь хостить обычный веб сайт, визитку, магазин и так далее - автор настоятельно рекомендует вам не страдать фигнёй, а развернуться целиком где-то в облаке. Домашний сервер оправдан для локальных сценариев вроде умного дома или хранилища (которое при этом резервируется в веб), но в долгосрочной перспективе принесёт вам боль и страдания, если вы положите туда что-то, что не должно там лежать и имеет требования по отказоустойчивости.</p>
<span id="more"></span>

<h1 id="1-Белый-статический-айпи"><a href="#1-Белый-статический-айпи" class="headerlink" title="1. Белый статический айпи"></a>1. Белый статический айпи</h1><p>Если вы являетесь счастливым обладателем статического внешнего айпи адреса, то и делать-то особо ничего не надо. Просто настраиваем свой сервер или роутер как веб сервер, максимум - пробрасываем с роутера порты.</p>
<p>Минусы такого варианта - нужно озаботиться безопасностью сервера, закрыть все лишние порты, а ещё вы оказываетесь прибиты гвоздями к этому физическому месту и своему провайдеру.</p>
<p>Если у вас нет белого статического айпи - переходим к пункту 2.</p>
<h1 id="2-Белый-динамический-айпи"><a href="#2-Белый-динамический-айпи" class="headerlink" title="2. Белый динамический айпи"></a>2. Белый динамический айпи</h1><p>Кажется, это уже экзотика, но встречается до сих пор. Проще всего настроиться через KeenDNS, который есть на роутерах Keenetic, DynDNS, DuckDNS или любой другой аналогичный сервис. Минусы такого решения те же, что со статическим адресом.</p>
<p>Если у вас нет белого динамического айпи - переходим к пункту 3. Он подойдёт для любой ситуации.</p>
<h1 id="3-Серый-айпи-или-закрытые-порты-на-доступ-извне"><a href="#3-Серый-айпи-или-закрытые-порты-на-доступ-извне" class="headerlink" title="3. Серый айпи или закрытые порты на доступ извне"></a>3. Серый айпи или закрытые порты на доступ извне</h1><p>Первые два варианта я упомянул скорее для формальности, потому что большая часть пользователей находится именно на серых айпи адресах, и без каких-то нестандартных финтов ушами опубликовать себя в интернет не сможет. Что же делать? Тут есть несколько вариантов.</p>
<h2 id="3-1-Используем-возможности-роутера"><a href="#3-1-Используем-возможности-роутера" class="headerlink" title="3.1 Используем возможности роутера"></a>3.1 Используем возможности роутера</h2><p>Как я уже упомянул ранее, у Keenetic есть сервис KeenDNS. И у него есть два режима работы. <code>Direct</code> - это собственно обычный DNS сервис, который поможет, если у вас публичный айпи адрес. И <code>Cloud</code>, который на самом деле не имеет никакого отношения к DNS, а просто прокидывает туннель к вашей локальной сети через облако Keenetic.</p>
<p>Вот вариант с облаком нам поможет в этой ситуации - парой галок можно получить свой облачный домен для сервиса, прокинуть порт от устройства в локальной сети наружу, сделать там Basic Auth, и ещё и SSL сертификат на него навесить. Просто сказка!</p>
<p>Лет 8 им пользовался, ни единого разрыва. Однако, минусы тоже есть:</p>
<ul>
<li>По умолчанию не прокидывается заголовок хоста. Поэтому я все эти годы мучался и вешал сервисы на разные порты. Прямо перед написанием статьи я всё же смог нагуглить решение и прокинуть заголовок - но <a target="_blank" rel="noopener" href="https://forum.keenetic.com/topic/9170-%D0%BF%D1%80%D0%BE%D0%B1%D1%80%D0%BE%D1%81%D0%B8%D1%82%D1%8C-%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D0%B5%D0%B5-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE%D0%B5-%D0%B8%D0%BC%D1%8F-%D0%B4%D0%BE-%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9-%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B/">это прям неочевидно</a>.</li>
<li>А вот Referer и Origin прокинуть <a target="_blank" rel="noopener" href="https://forum.keenetic.com/topic/17157-%D1%83%D0%B4%D0%B0%D0%BB%D1%8F%D1%8E%D1%82%D1%81%D1%8F-%D0%B7%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BF%D1%80%D0%B8-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B8-keendns/">так и не удаётся</a>. Хотя в реальной жизни я на это наступил ровно один раз, когда Authentik отказался пропускать мои запросы, защитившись от них при помощи CSRF. Пришлось руками прописать то, что должно быть в заголовках. Это, конечно, сводит защиту CSRF на ноль, но… Защита без токенов всё равно такое себе.</li>
<li>Ничто не вечно под луной, и в какой-то момент сервис может прилечь или прекратить работу, и тогда весь ваш веб станет резко недоступен</li>
<li>Паранойя может помешать вам гонять личный трафик через облако вендора роутера</li>
<li>Вы не сможете поменять роутер на роутер другой фирмы, и получите вендор лок</li>
<li>Скорее всего, на пропускную способность такого туннеля есть какое-то ограничение. В моих юз кейсах я с ним не сталкивался, но здравый смысл подсказывает, что его не может не быть.</li>
</ul>
<p>Ну и основная проблема при использовании такого решения - у вас может быть роутер другой фирмы. Не знаю, есть ли у них аналогичные сервисы, не встречал, может кто в комментариях поделится. Но если нету - идём дальше по списку решений!</p>
<h2 id="3-2-Используем-сторонний-сервис"><a href="#3-2-Используем-сторонний-сервис" class="headerlink" title="3.2 Используем сторонний сервис"></a>3.2 Используем сторонний сервис</h2><p>Есть немало сервисов, которые бесплатно или за символические деньги заниматся тем же, что KeenDNS - прокидывают вам туннель наружу.</p>
<p>Навскидку могу перечислить:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pinggy.io/">pinggy.io</a></li>
<li><a target="_blank" rel="noopener" href="https://localtonet.com/">localtonet.com</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.cloudflare.com/pages/how-to/preview-with-cloudflare-tunnel">cloudflare tunnel</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.cloudflare.com/cloudflare-one/">cloudflare zero trust</a></li>
<li><a target="_blank" rel="noopener" href="https://zrok.io/">zrok</a> кажется тоже умеет при self hosted установке, но я <a target="_blank" rel="noopener" href="https://github.com/openziti/zrok/issues/478">не осилил</a> найти инструкцию</li>
<li>вроде у google тоже есть какое-то туннелирование</li>
<li><a target="_blank" rel="noopener" href="https://ngrok.com/">ngrok</a> может за деньги дать вам кастомный домен, или бесплатно - постоянный, но случайно сгенерированный.</li>
</ul>
<p>В общем, вариантов много, можно найти что понравится. Минусы примерно те же самые, что у KeenDNS, за исключением отвязки от вендора вашего роутера.</p>
<p>Не нравится? Ну что же, для <del>упоротых</del> упорных есть уровень хардкора!</p>
<h2 id="3-3-Используем-собственное-облако-и-SSH-туннель"><a href="#3-3-Используем-собственное-облако-и-SSH-туннель" class="headerlink" title="3.3 Используем собственное облако и SSH туннель"></a>3.3 Используем собственное облако и SSH туннель</h2><p>Здесь должна быть картинка с троллейбусом из буханки хлеба, но мне лень её искать - вспомните и представьте самостоятельно.</p>
<p>Для данного решения вам потребуется:</p>
<ul>
<li>Сервер на внешнем хостинге с белым айпи на Linux</li>
<li>Домашний сервер на Linux</li>
<li>Домен, в котором вы управляете зонами и можете наклепать себе удобных поддоменов</li>
<li>Базовое знание Linux</li>
</ul>
<p>А кто говорил, что будет легко.</p>
<h3 id="3-3-1-Настраиваем-доступ-по-сертификату-на-свой-сервер"><a href="#3-3-1-Настраиваем-доступ-по-сертификату-на-свой-сервер" class="headerlink" title="3.3.1 Настраиваем доступ по сертификату на свой сервер"></a>3.3.1 Настраиваем доступ по сертификату на свой сервер</h3><p>Для начала нам понадобится настроить доступ по SSH с помощью сертификата. Под это есть много инструкций, больших и подробных, под любой дистрибутив - так что я не буду здесь пытаться их переплюнуть. Просто загуглите.</p>
<p>На выходе у вас должна с домашнего сервера отрабатывать команда <code>ssh user_login@mydomain.com -i /home/path_to_home_dir/.ssh/private_key</code> и по ней вы должны оказываться на своём сервере.</p>
<h3 id="3-3-2-Прокидываем-порт"><a href="#3-3-2-Прокидываем-порт" class="headerlink" title="3.3.2 Прокидываем порт"></a>3.3.2 Прокидываем порт</h3><p>Теперь мы воспользуемся особой серверной магией - при помощи ssh прокинем локальный порт на удалённый сервер.</p>
<p><code>ssh -R 8080:localhost:9000 user_login@mydomain.com -i /home/path_to_home_dir/.ssh/private_key -N</code></p>
<p>В этом примере порт <code>8080</code> нашей локальной машины прокидывается на <code>9000</code> порт удалённого сервера.</p>
<p>Подставьте вместо <code>8080</code> порт вашего приложения, а вместо <code>9000</code> - какой-нибудь свободный порт удалённого сервера. Тогда после выполнения команды ваш сервис должен стать доступен через ваш удалённый сервер по указанному порту.</p>
<p>Если не получилось - выставьте <code>AllowTcpForwarding yes</code> и <code>GatewayPorts yes</code> в <code>sshd_config</code> удалённого сервера и перезапустите ssh там.</p>
<p>Если всё ещё не получилось - временно выключите там фаервол или добавьте новый порт в его исключения.</p>
<p>Если всё ещё не получилось - stack overflow вам в помощь, задача супер стандартная.</p>
<h3 id="3-3-2-Проксируем-туннель-через-nginx"><a href="#3-3-2-Проксируем-туннель-через-nginx" class="headerlink" title="3.3.2 Проксируем туннель через nginx"></a>3.3.2 Проксируем туннель через nginx</h3><p>Скорее всего, у вас, как и у меня, немало приложений на домашнем сервере. Чтобы не поднимать под каждое из них отдельный туннель и порт, можно повесить всё на один порт и разруливать запросы по запрошенному домену.</p>
<p>Предположим, что локальный сервис у вас крутится на порту <code>8123</code>. Тогда конфиг сайта локального nginx будет примерно такой:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">upstream some_service &#123;</span><br><span class="line">       server 127.0.0.1:8123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name subdomain.mydomain.com;</span><br><span class="line">    access_log /var/log/nginx/service-access-remote.log main;</span><br><span class="line">    error_log /var/log/nginx/service-error-remote.log;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://some_service;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection &quot;Upgrade&quot;;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>То есть, все запросы, которые придут через туннель на порт <code>8080</code>, будут проверены на домен, и в случае, если домен равен <code>subdomain.mydomain.com</code> - будут переданы на порт <code>8123</code>.</p>
<p>Так же нам потребуется настроить удалённый nginx:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">upstream tunnel &#123;</span><br><span class="line">       server 127.0.0.1:9000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name subdomain.mydomain.com;</span><br><span class="line">    access_log /var/log/nginx/service-access.log main;</span><br><span class="line">    error_log /var/log/nginx/service-error.log;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://tunnel;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection &quot;Upgrade&quot;;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Теперь у нас есть полная цепочка:</p>
<ol>
<li>Запрос приходит на <code>80</code> порт удалённого сервера с указанием домена <code>subdomain.mydomain.com</code></li>
<li>Nginx на удалённом сервере слушает порт, видит домен, пишет логи доступа и отправляет запрос в туннель на порту <code>9000</code></li>
<li>Туннель “выныривает” на вашем локальном сервере на порту 8080 и попадает в локальный Nginx</li>
<li>Локальный nginx опять же видит домен и на его основании пересылает запрос уже в конечное приложение на порту <code>8123</code></li>
</ol>
<p>Звучит на первый взгляд сложно, зато позволяет через один туннель гонять сколько угодно запросов к различным сайтам сервера.</p>
<h3 id="3-3-3-Ни-единого-разрыва"><a href="#3-3-3-Ни-единого-разрыва" class="headerlink" title="3.3.3 Ни единого разрыва!"></a>3.3.3 Ни единого разрыва!</h3><p>Всё готово? Как бы не так! SSH туннель может упасть при обрыве коннекта, и вместо доступного извне сервера у вас окажется тыква.</p>
<p>Чтобы этого не случилось, можно воспользоваться пакетом <code>autossh</code> из штатного репозитория - он обеспечит автоматическое переподнятие туннеля.</p>
<p>Ставим пакет, и запускаем его примерно так:
<code>autossh -NR 8080:localhost:9000   -M 0   -o &quot;ServerAliveInterval 10&quot; -o &quot;ServerAliveCountMax 3&quot;   user_login@mydomain.com -i /home/path_to_home_dir/.ssh/private_key</code></p>
<p>Теперь туннель не умрёт. Но… Подождите, что же будет при ребуте локального сервера?</p>
<h3 id="3-3-4-Переживший-ребут"><a href="#3-3-4-Переживший-ребут" class="headerlink" title="3.3.4 Переживший ребут"></a>3.3.4 Переживший ребут</h3><p>Можно добавить команду в <code>@reboot</code> от cron, но мне кажется более правильным добавить новый системный сервис.</p>
<p>Добавляем настройку демона, например, в такой файл - <code>/etc/systemd/system/autossh.service</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">Unit</span>]</span><br><span class="line"><span class="string">Description=AutoSSH</span> <span class="string">to</span> <span class="string">My</span> <span class="string">Server</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"></span><br><span class="line">[<span class="string">Service</span>]</span><br><span class="line"><span class="string">Environment=&quot;AUTOSSH_GATETIME=0&quot;</span></span><br><span class="line"><span class="string">Environment=&quot;AUTOSSH_LOGFILE=/var/log/autossh&quot;</span></span><br><span class="line"><span class="string">ExecStart=autossh</span> <span class="string">-NR</span>  <span class="number">8080</span><span class="string">:localhost:9000</span> <span class="string">-M</span> <span class="number">0</span> <span class="string">-o</span> <span class="string">&quot;ExitOnForwardFailure=yes&quot;</span> <span class="string">-o</span> <span class="string">&quot;ServerAliveInterval=180&quot;</span> <span class="string">-o</span> <span class="string">&quot;ServerAliveCountMax=3&quot;</span> <span class="string">-o</span> <span class="string">&quot;PubkeyAuthentication=yes&quot;</span> <span class="string">-o</span> <span class="string">&quot;PasswordAuthentication=no&quot;</span> <span class="string">-i</span> <span class="string">/home/path_to_home_dir/.ssh/private_key</span> <span class="string">user_login@mydomain.com</span> <span class="string">-p</span> <span class="number">22</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"></span><br><span class="line">[<span class="string">Install</span>]</span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br></pre></td></tr></table></figure>

<p>После этого выполняем <code>systemctl daemon-reload</code> и <code>systemctl enable --now autossh</code>, проверяем логи в <code>/var/log/autossh</code>, и радуемся, что нам больше не страшны ребуты.</p>
<h3 id="3-3-5-Нет-пределов-совершенству"><a href="#3-3-5-Нет-пределов-совершенству" class="headerlink" title="3.3.5 Нет пределов совершенству"></a>3.3.5 Нет пределов совершенству</h3><p>Если вы думаете, что на этом всё - совсем нет! По хорошему, стоит так же защитить ваш сайт при помощи SSL - например, через Lets Encrypt, а если он приватный (например, управление умным домом) - то закрыть снаружи дополнительной авторизацией вроде Authentik.</p>
<p>Про это есть много хороших статей, так что я просто добавлю, что всё это можно делать уже только на удалённом сервере, поскольку ваш домашний и так закрыт вашей собственной сетью.</p>
<p>В итоге у вас может получиться какой-то такой конфиг внешнего nginx:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">upstream tunnel &#123;</span><br><span class="line">       server 127.0.0.1:9000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    server_name subdomain.mydomain.com;</span><br><span class="line">    access_log /var/log/nginx/tun-access.log main;</span><br><span class="line">    error_log /var/log/nginx/tun-error.log;</span><br><span class="line">    listen 443 ssl; # managed by Certbot</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/subdomain.mydomain.com/fullchain.pem; # managed by Certbot</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/subdomain.mydomain.com/privkey.pem; # managed by Certbot</span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://tunnel;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection &quot;Upgrade&quot;;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    ##############################</span><br><span class="line">    # authentik-specific config</span><br><span class="line">    ##############################</span><br><span class="line">    auth_request     /outpost.goauthentik.io/auth/nginx;</span><br><span class="line">    error_page       401 = @goauthentik_proxy_signin;</span><br><span class="line">    auth_request_set $auth_cookie $upstream_http_set_cookie;</span><br><span class="line">    add_header       Set-Cookie $auth_cookie;</span><br><span class="line"></span><br><span class="line">    # translate headers from the outposts back to the actual upstream</span><br><span class="line">    auth_request_set $authentik_username $upstream_http_x_authentik_username;</span><br><span class="line">    auth_request_set $authentik_groups $upstream_http_x_authentik_groups;</span><br><span class="line">    auth_request_set $authentik_email $upstream_http_x_authentik_email;</span><br><span class="line">    auth_request_set $authentik_name $upstream_http_x_authentik_name;</span><br><span class="line">    auth_request_set $authentik_uid $upstream_http_x_authentik_uid;</span><br><span class="line"></span><br><span class="line">    proxy_set_header X-authentik-username $authentik_username;</span><br><span class="line">    proxy_set_header X-authentik-groups $authentik_groups;</span><br><span class="line">    proxy_set_header X-authentik-email $authentik_email;</span><br><span class="line">    proxy_set_header X-authentik-name $authentik_name;</span><br><span class="line">    proxy_set_header X-authentik-uid $authentik_uid;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"># all requests to /outpost.goauthentik.io must be accessible without authentication</span><br><span class="line">location /outpost.goauthentik.io &#123;</span><br><span class="line">    proxy_pass              https://127.0.0.1:7443/outpost.goauthentik.io;</span><br><span class="line">    # ensure the host of this vserver matches your external URL you&#x27;ve configured</span><br><span class="line">    # in authentik</span><br><span class="line">    proxy_set_header        Host $host;</span><br><span class="line">    proxy_set_header        X-Original-URL $scheme://$http_host$request_uri;</span><br><span class="line">    add_header              Set-Cookie $auth_cookie;</span><br><span class="line">    auth_request_set        $auth_cookie $upstream_http_set_cookie;</span><br><span class="line">    proxy_pass_request_body off;</span><br><span class="line">    proxy_set_header        Content-Length &quot;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Special location for when the /auth endpoint returns a 401,</span><br><span class="line"># redirect to the /start URL which initiates SSO</span><br><span class="line">location @goauthentik_proxy_signin &#123;</span><br><span class="line">    internal;</span><br><span class="line">    add_header Set-Cookie $auth_cookie;</span><br><span class="line">    return 302 /outpost.goauthentik.io/start?rd=$request_uri;</span><br><span class="line">    # For domain level, use the below error_page to redirect to your authentik server with the full redirect path</span><br><span class="line">    # return 302 https://authentik.company/outpost.goauthentik.io/start?rd=$scheme://$http_host$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Вот теперь вы действительно великолепны.</p>
<h3 id="3-3-6-Плюсы-и-минусы-решения-с-туннелем"><a href="#3-3-6-Плюсы-и-минусы-решения-с-туннелем" class="headerlink" title="3.3.6 Плюсы и минусы решения с туннелем"></a>3.3.6 Плюсы и минусы решения с туннелем</h3><p>Плюсы:</p>
<ul>
<li>Вы сегодня много узнали</li>
<li>Вам не страшна замена роутера или падение внешнего сервиса</li>
<li>Никто не ограничит вас по скорости</li>
<li>Никто не слушает ваш трафик, но это не точно</li>
<li>Вы можете прокидывать любые заголовки, как только пожелаете</li>
<li>Вы можете поселиться на острове, запитывать сервер от бешеных белок, получать интернет через сотовую связь и спутник - и туннель продолжит работать, у него нет никакой привязки.</li>
</ul>
<p>Минусы:</p>
<ul>
<li>Вы сегодня много узнали</li>
<li>Первичная настройка занимает некоторое время</li>
<li>Придётся платить за облачный сервер и домен</li>
</ul>
<p>В общем, вариант выбирать вам. Я выбрал вариант с туннелем потому что мне было банально интересно разобраться, как это работает, и сделать оптимальную настройку туннеля под себя. Но и с другими вариантами вполне можно жить.</p>
<p>Наверняка я описал не все варианты и способы, докидывайте в комментариях. Напоследок - несколько ссылок, которые мне помогли разобраться:</p>
<h2 id="Ссылочки"><a href="#Ссылочки" class="headerlink" title="Ссылочки"></a>Ссылочки</h2><h3 id="SSH-туннели"><a href="#SSH-туннели" class="headerlink" title="SSH туннели"></a>SSH туннели</h3><ul>
<li><a target="_blank" rel="noopener" href="https://serverfault.com/questions/838160/http-server-through-reverse-ssh-tunneling">serverfault про туннелирование</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/autossh">мануал по autossh</a> - стоит почитать, я специально не расписывал, почему использую какие-то опции, чтобы не раздуть объём статьи в вечность</li>
</ul>
<h3 id="Обсуждения"><a href="#Обсуждения" class="headerlink" title="Обсуждения"></a>Обсуждения</h3><ul>
<li>очень скудное <a target="_blank" rel="noopener" href="https://qna.habr.com/q/509829">обсуждение на qna хабра</a> - поэтому я и сел писать статью</li>
<li><a target="_blank" rel="noopener" href="https://pinggy.io/blog/best_ngrok_alternatives/">неплохая подборка</a> вариантов сервисов по пробросу портов</li>
</ul>
<h1 id="Апдейт-по-мотивам-комментариев"><a href="#Апдейт-по-мотивам-комментариев" class="headerlink" title="Апдейт по мотивам комментариев"></a>Апдейт по мотивам комментариев</h1><ol>
<li>Можно ещё воспользоваться специализированными сервисами для конкретно вашего кейса - например, для Home Assistant есть <a target="_blank" rel="noopener" href="https://github.com/AlexxIT/Dataplicity">Dataplicity</a> и <a target="_blank" rel="noopener" href="https://www.nabucasa.com/about/">Nabu Casa</a></li>
<li>Вместо SSH туннеля можно использовать VPN к внешнему серверу и опять же прокидывать порты через Nginx. На первый взгляд кажется, что равнозначное ssh решение, в том числе по трудоёмкости.</li>
<li>А можно использовать VPN и не прокидывать его наружу через nginx. Тогда ваш сервис будет доступен снаружи откуда угодно - но только через VPN соединение. Что в некоторых случаях имеет смысл.</li>
<li>Говорят, что ещё одна альтернатива SSH и VPN - это zerotier. Не слышал про этого зверя, но кажется про него есть на хабре <a target="_blank" rel="noopener" href="https://habr.com/ru/companies/ruvds/articles/485914/">хорошая статья</a>.</li>
</ol>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/умный-дом/">умный дом</a>, <a href="/tags/home-assistant/">home assistant</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>

<!-- 
<section id="comment">
  <h1 class="title">Comments</h1>

  
</section>
 -->

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="as_sitesearch" value="articles.jehy.ru">
  </form>
</div>


  

  
<div class="widget tagcloud">
  <h3 class="title">Tag Cloud</h3>
  <div class="entry">
    <a href="/tags/MS-SQL/" style="font-size: 10px;">MS SQL</a> <a href="/tags/Oracle/" style="font-size: 11.25px;">Oracle</a> <a href="/tags/PHP/" style="font-size: 10.63px;">PHP</a> <a href="/tags/RHEL/" style="font-size: 10px;">RHEL</a> <a href="/tags/SAP/" style="font-size: 10px;">SAP</a> <a href="/tags/android/" style="font-size: 10.63px;">android</a> <a href="/tags/applet/" style="font-size: 11.88px;">applet</a> <a href="/tags/arduino/" style="font-size: 11.25px;">arduino</a> <a href="/tags/buddypress/" style="font-size: 10px;">buddypress</a> <a href="/tags/codesigning/" style="font-size: 10.63px;">codesigning</a> <a href="/tags/dev/" style="font-size: 15.63px;">dev</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/esphome/" style="font-size: 10.63px;">esphome</a> <a href="/tags/fun/" style="font-size: 15px;">fun</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/habr/" style="font-size: 19.38px;">habr</a> <a href="/tags/home-assistant/" style="font-size: 14.38px;">home assistant</a> <a href="/tags/java/" style="font-size: 11.88px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/livejournal/" style="font-size: 10px;">livejournal</a> <a href="/tags/medium/" style="font-size: 10.63px;">medium</a> <a href="/tags/mta/" style="font-size: 10px;">mta</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/openid/" style="font-size: 10.63px;">openid</a> <a href="/tags/skype/" style="font-size: 10px;">skype</a> <a href="/tags/webstart/" style="font-size: 11.88px;">webstart</a> <a href="/tags/wiki/" style="font-size: 11.88px;">wiki</a> <a href="/tags/wod/" style="font-size: 10px;">wod</a> <a href="/tags/wordpress/" style="font-size: 16.25px;">wordpress</a> <a href="/tags/wordpress-mu/" style="font-size: 10px;">wordpress mu</a> <a href="/tags/yum/" style="font-size: 10px;">yum</a> <a href="/tags/%D0%B0%D0%BD%D0%B8%D0%BC%D0%B5/" style="font-size: 11.88px;">аниме</a> <a href="/tags/%D0%B1%D0%B5%D0%B3/" style="font-size: 10px;">бег</a> <a href="/tags/%D0%B8%D0%BD%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%86%D0%B8%D1%8F/" style="font-size: 10.63px;">инквизиция</a> <a href="/tags/%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82%D1%8B/" style="font-size: 11.25px;">интернеты</a> <a href="/tags/%D0%B8%D1%81%D1%82%D0%BE%D1%80%D0%B8%D0%B8/" style="font-size: 20px;">истории</a> <a href="/tags/%D0%BA%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/" style="font-size: 13.75px;">картинки</a> <a href="/tags/%D0%BA%D0%B8%D0%BD%D0%BE/" style="font-size: 15px;">кино</a> <a href="/tags/%D0%BA%D0%BD%D0%B8%D0%B6%D0%BD%D0%BE%D0%B5/" style="font-size: 17.5px;">книжное</a> <a href="/tags/%D0%BA%D0%BF%D0%BA/" style="font-size: 10.63px;">кпк</a> <a href="/tags/%D0%BB%D0%B8%D0%BD%D1%83%D0%BA%D1%81/" style="font-size: 10px;">линукс</a> <a href="/tags/%D0%BC%D0%B0%D0%BD%D0%B3%D0%B0/" style="font-size: 10.63px;">манга</a> <a href="/tags/%D0%BC%D1%83%D0%B7%D1%8B%D0%BA%D0%B0/" style="font-size: 18.13px;">музыка</a> <a href="/tags/%D0%BC%D1%8B%D1%81%D0%BB%D0%B8/" style="font-size: 16.88px;">мысли</a> <a href="/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4%D1%8B/" style="font-size: 15px;">переводы</a> <a href="/tags/%D0%BF%D0%BE-%D0%B6%D0%B8%D0%B7%D0%BD%D0%B8/" style="font-size: 10.63px;">по жизни</a> <a href="/tags/%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0/" style="font-size: 10.63px;">политика</a> <a href="/tags/%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0/" style="font-size: 10.63px;">работа</a> <a href="/tags/%D1%80%D0%BE%D0%BB%D0%B5%D0%B2%D1%8B%D0%B5-%D0%B8%D0%B3%D1%80%D1%8B/" style="font-size: 13.13px;">ролевые игры</a> <a href="/tags/%D1%82%D0%B0%D1%80%D0%BE/" style="font-size: 11.88px;">таро</a> <a href="/tags/%D1%83%D0%BC%D0%BD%D1%8B%D0%B9-%D0%B4%D0%BE%D0%BC/" style="font-size: 14.38px;">умный дом</a> <a href="/tags/%D1%83%D1%87%D0%B5%D0%B1%D0%BD%D0%BE%D0%B5/" style="font-size: 12.5px;">учебное</a> <a href="/tags/%D1%85%D0%B8%D0%BA%D0%BA%D0%B8/" style="font-size: 10px;">хикки</a> <a href="/tags/%D1%86%D0%B5%D1%80%D0%BA%D0%BE%D0%B2%D1%8C/" style="font-size: 10.63px;">церковь</a> <a href="/tags/%D1%86%D0%B8%D1%82%D0%B0%D1%82%D1%8B/" style="font-size: 18.75px;">цитаты</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2025/02/умный-дом-на-канале-яндекса/">Мой умный дом на канале яндекса</a>
      </li>
    
      <li>
        <a href="/2024/09/отчёт-по-трясине/">Отчёт по «Трясине» от МГ «... И Животноводство».</a>
      </li>
    
      <li>
        <a href="/2024/07/self-hosted-для-домашнего-сервера/">Self Hosted для домашнего сервера</a>
      </li>
    
      <li>
        <a href="/2024/07/докер-контейнеры-и-прикладная-некромантия/">Докер контейнеры и прикладная некромантия</a>
      </li>
    
      <li>
        <a href="/2024/05/отчёт-по-эйре/">Отчёт по «Книге Эйре»</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><!--<div class="alignleft">
  
  &copy; 2025 Jehy
  
</div>-->
<div class="clearfix"></div>
</footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
